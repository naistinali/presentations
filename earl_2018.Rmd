---
title: "A 'caret'-based Framework for Training Multiple Tax Fraud Detection Models"
author: "Lars Kjeldgaard <br/> lars.kjeldgaard@ufst.dk"
date: "EARL 2018/09/13"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
```{r, include = FALSE}
library(modelgrid)
library(magrittr)
library(dplyr)
library(ggplot2)
library(lattice)
```

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

# About me

- Data Scientist working at the Danish Tax Authorities

- Apply predictive modelling to detect tax fraud

- Author of the **modelgrid** package (which I will show you in action in just a bit)

- Active blogger on R-bloggers

<figure>
  <img src= "larsk.png" height = "250", align = "right">
</figure>

---

# Tax Fraud Detection

- Sample of 8,000 checks of companies

- 1 out of 10 companies were found to be *fraudulent*

- 150 features

- Predict which companies are fraudulent

- Binary classification problem

```{r compliance_modspillere, echo = FALSE, fig.align = "center", fig.height = 3, fig.width = 7, dev = 'svg'}
load("~/erhverv_abt.rda")
  abt %>%
  mutate(year = aar,
         Fraudulent = ifelse(klasse == "MS", "Fraudulent", "Not fraudulent")) %>%
  ggplot(aes(year)) +
  geom_bar(aes(fill = Fraudulent)) +
  ggtitle("Fraudulent companies over time")
```

---
# Training a single model with 'caret'

Until recently we have trained models one at the time with **caret**
<!-- - often using the 'caret' package: -->

```{r, message = FALSE}
library(caret); data(GermanCredit)
```

Set parameters, that control the model training
<!-- (including resampling scheme,  -->
<!-- parallel back-end, preprocessing options, output). -->

```{r}
tr_control <- trainControl(method = "cv", number = 5,
                          summaryFunction = twoClassSummary,
                          classProbs = TRUE)
```

Set all other model options and train model
<!-- Choose target variable, features, algorithm, tuning options and train model. -->
```{r, eval = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
model <- train(y = GermanCredit %>% pull(Class),
               x = GermanCredit %>% select(-Class),
               method = "rf", tuneLength = 5,
               trControl = tr_control)
```
---
# Framework for experiments with multiple models
We wanted some kind of structure to organize and keep track of all our experiments
with different models, preprocessing options etc.

For that reason we developed the **modelgrid** package (available on
[CRAN](https://cran.r-project.org/web/packages/modelgrid/index.html)). It offers a pipe-friendly
framework to construct, manage and train (potentially many) **caret** models - and doing so with
a bare minimum of code.

<figure>
  <img src = "mglogo.png", align = "right">
</figure>

---
# How 'modelgrid' works 1/3
Create empty model grid with constructur function:

```{r}
library(modelgrid)
credit_default_models <- model_grid()
```

Set settings you want to apply to all models:

```{r}
credit_default_models <-
  credit_default_models %>%
  share_settings(
    y = GermanCredit %>% pull(Class),
    x = GermanCredit %>% select(-Class),
    metric = "ROC",
    trControl = tr_control
  )
```
---
# How 'modelgrid' works 2/3

Add individual model specifications to the model grid.

First add a Random Forest model.
```{r}
credit_default_models <-
  credit_default_models %>%
  add_model(model_name = "Funky Forest",
            method = "rf",
            tuneGrid = data.frame(mtry = c(3, 10, 20)))
```

Let's also try an eXtreme Gradient Boosting model.
```{r}
credit_default_models <-
  credit_default_models %>%
  add_model(model_name = "Big Boost",
            method = "xgbTree",
            nthread = 8)
```

Train models.
```{r, message = FALSE, warning = FALSE}
credit_default_models <- credit_default_models %>% train(.)
```

---
# How 'modelgrid' works 3/3
The fitted models are now saved alongside the model configurations in the model grid.

```{r fig.align = "center", fig.height = 4, dev = 'svg'}
credit_default_models$model_fits %>% resamples(.) %>% bwplot(.)
```

---
# Leverage 'modelgrid' with recipes 1/3
Include preprocessing in model development...
<!-- The preprocessing of the data (imputation, feature engineering, dimensionality reduction,  -->
<!-- feature selection) is an integrated part of the model configuration, and we wanted to incorporate -->
<!-- preprocessing in the model grid. This is done by drawing upon the 'recipes' package.  -->

Prep a model grid:

```{r}
credit_default_models <-
  model_grid() %>%
  share_settings(
    data = GermanCredit,
    metric = "ROC",
    trControl = tr_control
  )
```


Create a really basic recipe (this will be the *anchor* for all models):

```{r message = FALSE, warning = FALSE}
library(recipes)
rec <-
  recipe(GermanCredit) %>%
  add_role(Class, new_role = "outcome") %>%
  add_role(-Class, new_role = "predictor") %>%
  step_zv(all_predictors())
```

---
# Leverage 'modelgrid' with recipes 2/3
Create Random Forest model with no additional preprocessing:

```{r}
credit_default_models <-
  credit_default_models %>%
  add_model("rF_zv", method = "rf", x = rec, tuneLength = 3)
```

Create Random Forest model with PCA for dimensionality reduction:

```{r}
credit_default_models <-
  credit_default_models %>%
  add_model("rF_zv_pca", method = "rf", tuneLength = 3,
    x = rec %>%
    step_center(all_predictors(), -all_nominal()) %>%
    step_scale(all_predictors(), -all_nominal()) %>%
    step_pca(all_predictors(), -all_nominal()))
```

---
# Leverage 'modelgrid' with recipes 3/3

Train models and display results:

```{r message = FALSE, warning = FALSE, fig.height = 4, fig.align = "center", dev = 'svg'}
credit_default_models <- train(credit_default_models)
credit_default_models$model_fits %>% resamples(.) %>% bwplot(.)
```

---
# Tax Fraud Detection - Training results

```{r fig.align = "center", fig.height = 6, fig.width = 8, dev = 'svg', echo = FALSE}
roc <- readRDS("~/earl_roc.rds")

p <- ggplot2::ggplot(roc, ggplot2::aes(x=model, y=ROC)) +
  ggplot2::geom_boxplot() +
  ggplot2::coord_flip()

p
```